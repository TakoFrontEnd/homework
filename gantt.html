<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>甘特圖</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/vue@3.2.47/dist/vue.global.prod.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-dragdata@2.2.5/dist/chartjs-plugin-dragdata.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/3.0.1/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@latest"></script>
<style>
  * {
    margin: 0;
    padding: 0;
    font-family: sans-serif;
  }
  .chartMenu {
    width: 100vw;
    height: 40px;
    background: #1A1A1A;
    color: rgba(54, 162, 235, 1);
  }
  .chartMenu p {
    padding: 10px;
    font-size: 20px;
  }
  .chartCard {
    width: 100vw;
    height: calc(100vh - 40px);
    background: rgba(54, 162, 235, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .chartBox {
    width: 900px;
    padding: 20px;
    border-radius: 20px;
    border: solid 3px rgba(54, 162, 235, 1);
    background: white;
  }
</style>
</head>
<body>
<div id="app" class="chartCard">
  <div class="chartBox">
    <canvas ref="myChart"></canvas>
    <button type="button" class="btn btn-primary" v-on:click="togglePause">{{ paused ? '恢復更新' : '暫停更新' }}</button>
  </div>
</div>

<script>
const { createApp, ref, onMounted } = Vue;

createApp({
  setup() {
    const myChart = ref(null);
    let chartInstance = null;
    const paused = ref(false); // 暫停狀態



    
    const zoomOptions = {
      pan: {
        enabled: true,
        modifierKey: 'ctrl',
      },
      zoom: {
        wheel: {
          enabled: true,
          speed: 0.1, // 控制縮放的速度
          mode: 'x',  // 僅在x軸（時間軸）進行縮放
          threshold: 2,
          sensitivity: 3,
          limit: {
            max: 10, // 最大縮放級別
            min: 0.5  // 最小縮放級別
          }
        },
        pinch: {
          enabled: true,
          mode: 'x'
        },
        mode: 'x'
      },
    };

    // Function to create the chart
    const createChart = (data) => {
      const ctx = myChart.value.getContext('2d');

      const config = {
        type: 'bar',
        data,
        options: {
          borderRadius: 5,
          borderSkipped: false,
          borderWidth: 2,
          animation: false,
          parsing: {
            xAxisKey: 'start',
            yAxisKey: 'device',
          },
          plugins: {
            zoom: zoomOptions,
            annotation: {
              drawTime: 'afterDraw',
              events: ['click'],
              
            },
            tooltip: {
              enabled: true,
              padding: 10,
              displayColors: true,
              callbacks: {
                label: (context) => {
                  const startTime = new Date(context.dataset.data[context.dataIndex].start[0]).toLocaleDateString();
                  const endTime = new Date(context.dataset.data[context.dataIndex].start[1]).toLocaleDateString();
                  const status = context.dataset.label;
                  const statusColor = context.dataset.backgroundColor;
                  //console.log(context.dataset.data[context.dataIndex]);
                  return [
                    `Status: ${status}`,
                    `StatusColor: ${statusColor}`,
                    `StartEnd: ${startTime} ~ ${endTime}`
                  ];
                }
              }
            }
          },
          indexAxis: 'y',
          scales: {
            x: {
              min: '2024-06-01',
              position: 'bottom',
              type: 'time',
              parser: 'yyyy-MM-DD',
              tooltipFormat: 'yyyy-MM-DD HH:mm:ss.SSS',
              time: {
                unit: 'day',
                displayFormats: {
                  millisecond: 'HH:mm:ss.SSS', // Display millisecond-level time format
                  second: 'HH:mm:ss', // Display second-level format
                  minute: 'HH:mm', // Display minute-level format
                  hour: 'HH:mm', // Display hour-level format
                  day: 'MMM d', // Display date
                  month: 'MMM yyyy', // Corrected from 'MMM YYYY' to 'MMM yyyy'
                  year: 'yyyy' // Corrected from 'YYYY' to 'yyyy'
                }
              },
              ticks: {
                autoSkip: true,
                autoSkipPadding: 50,
                maxRotation: 0,
                major: { enabled: true },
                align: 'start',
              }
            },
            y: {
              stacked: false,
              beginAtZero: true,
            }
          }
        } //
      };
      if (chartInstance){
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, config);
    };

    // Function to fetch data from the JSON file
    const fetchData = () => {
      if (!paused.value) { // 如果暫停狀態為 false 才執行
        fetch('data1.json')
          .then(response => response.json())
          .then(data => {
            console.log('Fetched data:', data);
            createChart(data);
          })
          .catch(error => {
            console.log('Error fetching data:', error);
          });
      }
    };

    // Lifecycle hook to fetch data when the component is mounted
    onMounted(() => {
      fetchData();
      setInterval(fetchData, 1000);
    });

    const togglePause = () => {
      paused.value = !paused.value;
    };

    return { myChart, togglePause, paused };
  }
}).mount('#app');
</script>
</body>
</html>
